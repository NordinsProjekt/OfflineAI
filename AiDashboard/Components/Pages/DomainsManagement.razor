@page "/domains"
@rendermode InteractiveServer
@using Application.AI.Utilities
@inject IDomainDetector DomainDetector
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Knowledge Domains</PageTitle>

<div class="domain-management-container">
	<div class="page-header">
		<div class="header-content">
			<div>
				<h2>Knowledge Domains</h2>
				<p class="subtitle">Manage knowledge domains and their search keywords for intelligent filtering</p>
			</div>
			<button class="btn-back" @onclick="NavigateToHome">
				? Back to Chat
			</button>
		</div>
	</div>

	@if (!string.IsNullOrWhiteSpace(statusMessage))
	{
		<div class="alert @(statusMessage.StartsWith("[OK]") ? "alert-success" : statusMessage.StartsWith("[ERROR]") ? "alert-danger" : "alert-info")">
			@statusMessage
		</div>
	}

	<div class="management-layout">
		<!-- Left Panel: Domain List -->
		<div class="domain-list-panel">
			<div class="panel-header">
				<h3>Registered Domains</h3>
				<button class="btn-refresh" @onclick="RefreshDomains" disabled="@isLoading">
					<span class="@(isLoading ? "spinner" : "")"></span> Refresh
				</button>
			</div>

			@if (isLoading)
			{
				<div class="loading-state">
					<div class="spinner-large"></div>
					<p>Loading domains...</p>
				</div>
			}
			else if (!filteredDomains.Any())
			{
				<div class="empty-state">
					<div class="empty-icon">[]</div>
					<h4>No domains registered yet</h4>
					<p>Add your first domain using the form on the right</p>
				</div>
			}
			else
			{
				@foreach (var categoryGroup in filteredDomains.GroupBy(d => d.Category).OrderBy(g => g.Key))
				{
					<div class="category-group">
						<div class="category-header">
							<h4>@FormatCategoryName(categoryGroup.Key)</h4>
							<span class="count-badge">@categoryGroup.Count()</span>
						</div>
						<div class="domain-list">
							@foreach (var domain in categoryGroup.OrderBy(d => d.DisplayName))
							{
								@RenderDomainCard(domain)
							}
						</div>
					</div>
				}
			}
		</div>

		<!-- Right Panel: Add/Edit Domain -->
		<div class="domain-form-panel">
			<div class="panel-header">
				<h3>@(isEditMode ? "Edit Domain" : "Add New Domain")</h3>
				@if (isEditMode)
				{
					<button class="btn-link" @onclick="CancelEdit">Cancel</button>
				}
			</div>

			<div class="form-content">
				<div class="form-group">
					<label for="domainId">Domain ID <span class="required">*</span></label>
					<input type="text"
					       id="domainId"
					       class="form-control"
					       @bind="formDomainId"
					       placeholder="e.g., gloomhaven, iphone-15, project-alpha"
					       disabled="@isEditMode"/>
					<small class="form-text">Lowercase with hyphens, used for internal identification</small>
				</div>

				<div class="form-group">
					<label for="displayName">Display Name <span class="required">*</span></label>
					<input type="text"
					       id="displayName"
					       class="form-control"
					       @bind="formDisplayName"
					       placeholder="e.g., Gloomhaven, iPhone 15, Project Alpha"/>
					<small class="form-text">User-friendly name shown in the UI</small>
				</div>

				<div class="form-group">
					<label for="category">Category <span class="required">*</span></label>
					<select id="category" class="form-control" @bind="formCategory">
						<option value="">Select a category...</option>
						<option value="board-game">Board Game</option>
						<option value="product">Product</option>
						<option value="project">Project</option>
						<option value="academic">Academic</option>
						<option value="technical">Technical</option>
						<option value="internal">Internal</option>
						<option value="general">General</option>
						<option value="custom">Custom</option>
					</select>
					@if (formCategory == "custom")
					{
						<input type="text"
						       class="form-control mt-2"
						       @bind="formCustomCategory"
						       placeholder="Enter custom category name"/>
					}
					<small class="form-text">Organize domains by type for easier filtering</small>
				</div>

				<div class="form-group">
					<label for="variants">Search Keywords <span class="required">*</span></label>
					<textarea id="variants" 
                              class="form-control" 
                              rows="4" 
                              @bind="formVariants" 
                              placeholder="Enter search keywords (one per line):
gloomhaven
gloom haven
gh"></textarea>
					<small class="form-text">Text patterns to match in user queries (one per line)</small>
				</div>

				<div class="form-actions">
					<button class="btn-primary" @onclick="SaveDomain" disabled="@(!IsFormValid() || isSaving)">
						@if (isSaving)
						{
							<span class="spinner-small"></span>
						}
						@(isEditMode ? "Update Domain" : "Add Domain")
					</button>
					@if (isEditMode)
					{
						<button class="btn-secondary" @onclick="CancelEdit">Cancel</button>
					}
				</div>
			</div>
		</div>
	</div>

	@if (!string.IsNullOrWhiteSpace(selectedDomainId) && selectedDomainKeywords.Any())
	{
		<div class="keywords-panel">
			<div class="panel-header">
				<h3>Search Keywords for: @selectedDomainDisplayName</h3>
				<span class="keyword-count">@selectedDomainKeywords.Count keyword(s)</span>
			</div>
			<div class="keyword-list">
				@foreach (var keyword in selectedDomainKeywords.OrderBy(k => k))
				{
					<div class="keyword-chip">
						<span class="keyword-text">@keyword</span>
					</div>
				}
			</div>
		</div>
	}
</div>

@code {

	private RenderFragment RenderDomainCard((string DomainId, string DisplayName, string Category) domain) => __builder =>
	{
		<div class="domain-card @(selectedDomainId == domain.DomainId ? "selected" : "")"
		     @onclick="() => SelectDomain(domain.DomainId)">
			<div class="domain-card-header">
				<div class="domain-info">
					<h4>@domain.DisplayName</h4>
					<span class="domain-id">@domain.DomainId</span>
				</div>
			</div>
			<div class="domain-card-actions">
				<button class="btn-icon" @onclick:stopPropagation="true" @onclick="() => EditDomain(domain.DomainId)" title="Edit">
					Edit
				</button>
				<button class="btn-icon btn-danger" @onclick:stopPropagation="true" @onclick="() => DeleteDomain(domain.DomainId)" title="Delete">
					Delete
				</button>
			</div>
		</div>
	};

}

@code {
	private List<(string DomainId, string DisplayName, string Category)> domains = new();
	private List<(string DomainId, string DisplayName, string Category)> filteredDomains = new();
	private List<string> categories = new();

	private string? selectedDomainId = null;
	private string? selectedDomainDisplayName = null;
	private List<string> selectedDomainKeywords = new();

	private string formDomainId = "";
	private string formDisplayName = "";
	private string formCategory = "";
	private string formCustomCategory = "";
	private string formVariants = "";

	private bool isLoading = false;
	private bool isSaving = false;
	private bool isEditMode = false;
	private string statusMessage = "";

	protected override async Task OnInitializedAsync()
	{
		await RefreshDomains();
	}

	private void NavigateToHome()
	{
		Navigation.NavigateTo("/");
	}

	private async Task RefreshDomains()
	{
		isLoading = true;
		statusMessage = "";
		StateHasChanged();

		try
		{
			domains = await DomainDetector.GetAllDomainsAsync();
			categories = await DomainDetector.GetCategoriesAsync();
			filteredDomains = domains;
			statusMessage = $"[OK] Loaded {domains.Count} domain(s) in {categories.Count} categor{(categories.Count == 1 ? "y" : "ies")}";
		}
		catch (Exception ex)
		{
			statusMessage = $"[ERROR] Failed to load domains: {ex.Message}";
		}
		finally
		{
			isLoading = false;
			StateHasChanged();
		}
	}

	private async Task SelectDomain(string domainId)
	{
		selectedDomainId = domainId;
		var domain = domains.FirstOrDefault(d => d.DomainId == domainId);
		selectedDomainDisplayName = domain.DisplayName;

		await DomainDetector.RefreshCacheAsync();

		selectedDomainKeywords = new List<string>();
		statusMessage = $"[INFO] Selected: {selectedDomainDisplayName} ({FormatCategoryName(domain.Category)})";

		StateHasChanged();
	}

	private void EditDomain(string domainId)
	{
		var domain = domains.FirstOrDefault(d => d.DomainId == domainId);
		if (domain.DomainId == null)
			return;

		isEditMode = true;
		formDomainId = domain.DomainId;
		formDisplayName = domain.DisplayName;
		formCategory = domain.Category;
		formCustomCategory = "";
		selectedDomainId = domainId;

		formVariants = "# Keywords will be loaded...\n# Edit and save to update";

		statusMessage = $"[INFO] Editing {domain.DisplayName}";
		StateHasChanged();
	}

	private async Task SaveDomain()
	{
		if (!IsFormValid())
			return;

		isSaving = true;
		statusMessage = "";
		StateHasChanged();

		try
		{
			var variants = formVariants
				.Split('\n', StringSplitOptions.RemoveEmptyEntries)
				.Where(v => !v.Trim().StartsWith("#"))
				.Select(v => v.Trim())
				.Where(v => !string.IsNullOrWhiteSpace(v))
				.ToArray();

			if (variants.Length == 0)
			{
				statusMessage = "[ERROR] Please add at least one search keyword";
				return;
			}

			var category = formCategory == "custom" ? formCustomCategory.Trim() : formCategory;

			if (string.IsNullOrWhiteSpace(category))
			{
				statusMessage = "[ERROR] Please select or enter a category";
				return;
			}

			await DomainDetector.RegisterDomainAsync(
				formDomainId.Trim(),
				formDisplayName.Trim(),
				category,
				variants);

			statusMessage = $"[OK] Successfully {(isEditMode ? "updated" : "added")} domain: {formDisplayName}";

			await RefreshDomains();
			CancelEdit();
		}
		catch (Exception ex)
		{
			statusMessage = $"[ERROR] Failed to save domain: {ex.Message}";
		}
		finally
		{
			isSaving = false;
			StateHasChanged();
		}
	}

	private async Task DeleteDomain(string domainId)
	{
		var domain = domains.FirstOrDefault(d => d.DomainId == domainId);
		if (domain.DomainId == null)
			return;

		var confirmed = await JSRuntime.InvokeAsync<bool>(
			"confirm",
			$"Delete domain '{domain.DisplayName}'?\n\nThis will permanently remove the domain and all its keywords.");

		if (!confirmed)
			return;

		try
		{
			await DomainDetector.DeleteDomainAsync(domainId);
			statusMessage = $"[OK] Deleted domain: {domain.DisplayName}";

			if (selectedDomainId == domainId)
			{
				selectedDomainId = null;
				selectedDomainDisplayName = null;
				selectedDomainKeywords.Clear();
			}

			await RefreshDomains();
		}
		catch (Exception ex)
		{
			statusMessage = $"[ERROR] Failed to delete domain: {ex.Message}";
		}
	}

	private void CancelEdit()
	{
		isEditMode = false;
		formDomainId = "";
		formDisplayName = "";
		formCategory = "";
		formCustomCategory = "";
		formVariants = "";
		selectedDomainId = null;
		StateHasChanged();
	}

	private bool IsFormValid()
	{
		var category = formCategory == "custom" ? formCustomCategory.Trim() : formCategory;

		return !string.IsNullOrWhiteSpace(formDomainId) &&
		       !string.IsNullOrWhiteSpace(formDisplayName) &&
		       !string.IsNullOrWhiteSpace(category) &&
		       !string.IsNullOrWhiteSpace(formVariants);
	}

	private string FormatCategoryName(string category) =>
		string.IsNullOrWhiteSpace(category)
			? "Uncategorized"
			: category.Replace("-", " ")
				.Split(' ')
				.Select(word => char.ToUpper(word[0]) + word.Substring(1))
				.Aggregate((a, b) => $"{a} {b}");

	public void Dispose()
	{
		// Cleanup if needed
	}

}