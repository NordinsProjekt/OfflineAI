@page "/document-analysis"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject DashboardState Dashboard
@inject IDocumentAnalysisService AnalysisService
@inject IKursplanAnalysisService KursplanService
@inject IDocumentTypeDetector TypeDetector
@inject IJSRuntime JSRuntime

@using System.IO
@using UglyToad.PdfPig

<PageTitle>Document Analysis - OfflineAI</PageTitle>

<div class="oa-workflow-page">
    <div class="oa-workflow-header">
        <button class="oa-back-button" @onclick="@(() => Navigation.NavigateTo("/"))">
            &larr; Back to Home
        </button>
        <h1>Document Analysis</h1>
        <p class="oa-workflow-subtitle">Upload any document and choose how you want to analyze it</p>
    </div>

    <div class="oa-workflow-content">
        <div class="oa-upload-section">
            <div id="upload-area" class="oa-upload-area @(isDragOver ? "drag-over" : "")"
                 @ondrop="HandleDrop"
                 @ondragover:preventDefault
                 @ondragenter="HandleDragEnter"
                 @ondragleave="HandleDragLeave">
                
                @if (uploadedFile == null)
                {
                    <div class="oa-upload-prompt">
                        <div class="oa-upload-icon">[+]</div>
                        <h2>Drop your document here</h2>
                        <p>or click to browse</p>
                        <InputFile @ref="fileInput" id="file-input" OnChange="HandleFileSelected" class="oa-file-input" accept=".txt,.doc,.docx,.pdf" />
                        <p class="oa-upload-hint">Supports: TXT, DOCX, PDF (Max 10MB)</p>
                    </div>
                }
                else
                {
                    <div class="oa-file-preview">
                        <div class="oa-file-icon">[DOC]</div>
                        <div class="oa-file-info">
                            <h3>@uploadedFile.Name</h3>
                            <p>@FormatFileSize(uploadedFile.Size)</p>
                            @if (documentChunks.Count > 0)
                            {
                                <p class="oa-chunk-info">Loaded successfully</p>
                            }
                        </div>
                        <button class="oa-remove-file" @onclick="RemoveFile">X</button>
                    </div>
                }
            </div>

            @* Show detected document type *@
            @if (detectedType != null && uploadedFile != null && string.IsNullOrEmpty(errorMessage))
            {
                <div class="oa-type-detection">
                    <div class="oa-type-badge @GetTypeClass(detectedType.Type)">
                        <span class="oa-type-icon">@TypeDetector.GetTypeIcon(detectedType.Type)</span>
                        <span class="oa-type-name">@TypeDetector.GetTypeName(detectedType.Type)</span>
                        <span class="oa-type-confidence">@detectedType.Confidence% confidence</span>
                    </div>
                    <p class="oa-type-reason">@detectedType.Reason</p>
                </div>
            }

            @if (uploadedFile != null && !isAnalyzing && !string.IsNullOrEmpty(errorMessage))
            {
                <div class="oa-error-message">
                    <strong>Error:</strong> @errorMessage
                </div>
            }

            @if (uploadedFile != null && !isAnalyzing && string.IsNullOrEmpty(errorMessage))
            {
                <div class="oa-analysis-options">
                    <h3>What would you like to do with this document?</h3>
                    <p class="oa-options-subtitle">Choose an analysis type below</p>
                    
                    <div class="oa-option-grid">
                        @* Generic Options - Always Shown *@
                        <button class="oa-option-button" @onclick='@(() => AnalyzeDocument("summarize"))'>
                            <span class="oa-option-icon">[SUM]</span>
                            <span class="oa-option-text">Summarize</span>
                            <span class="oa-option-description">Get a concise summary</span>
                        </button>

                        <button class="oa-option-button" @onclick='@(() => AnalyzeDocument("qa"))'>
                            <span class="oa-option-icon">[Q&A]</span>
                            <span class="oa-option-text">Ask Questions</span>
                            <span class="oa-option-description">Interactive Q&A mode</span>
                        </button>

                        @* Recommended Actions from TypeDetector *@
                        @foreach (var action in recommendedActions)
                        {
                            <button class="oa-option-button @(action.IsRecommended ? "oa-featured" : "")" 
                                    @onclick="@(() => AnalyzeDocument(action.Id))">
                                <span class="oa-option-icon">@GetActionIcon(action.Id)</span>
                                <span class="oa-option-text">@action.Label</span>
                                @if (action.IsRecommended)
                                {
                                    <span class="oa-option-badge">Rekommenderad</span>
                                }
                            </button>
                        }
                    </div>
                </div>
            }
        </div>

        @if (isAnalyzing)
        {
            <div class="oa-analyzing">
                <div class="oa-spinner"></div>
                <h3>@analysisStatus</h3>
                @if (!string.IsNullOrEmpty(analysisSubStatus))
                {
                    <p>@analysisSubStatus</p>
                }
                @if (showAbortButton)
                {
                    <p style="margin-top: 1.5rem; font-size: 0.9rem; color: var(--text-muted);">
                        Analysering pågår... Du kan avbryta om det tar för lång tid.
                    </p>
                    <button class="oa-abort-button" @onclick="AbortAnalysis">
                        Avbryt analys
                    </button>
                }
            </div>
        }

        @if (!string.IsNullOrEmpty(analysisResult))
        {
            <div class="oa-results-section">
                <h2>Analysresultat</h2>
                @if (kursplanResult != null)
                {
                    <div class="oa-kursplan-summary">
                        <div class="oa-summary-stat">
                            <span class="oa-stat-number">@kursplanResult.TotalItems</span>
                            <span class="oa-stat-label">KURSMÅL TOTALT</span>
                        </div>
                        <div class="oa-summary-stat">
                            <span class="oa-stat-number">@kursplanResult.Sections.Count</span>
                            <span class="oa-stat-label">SEKTIONER</span>
                        </div>
                    </div>
                }
                
                @if (isQAMode)
                {
                    @* Q&A Interactive Mode *@
                    <div class="oa-qa-container">
                        @* Q&A History *@
                        @if (qaHistory.Count > 0)
                        {
                            <div class="oa-qa-history">
                                @foreach (var (question, answer) in qaHistory)
                                {
                                    <div class="oa-qa-exchange">
                                        <div class="oa-qa-question">
                                            <span class="oa-qa-label">Q:</span>
                                            <span class="oa-qa-text">@question</span>
                                        </div>
                                        <div class="oa-qa-answer">
                                            <span class="oa-qa-label">A:</span>
                                            <span class="oa-qa-text">@answer</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }

                        @* Q&A Input *@
                        <div class="oa-qa-input-section">
                            <h3>Ask a question about the document</h3>
                            <div class="oa-qa-input-box">
                                <input type="text" 
                                       class="oa-qa-input" 
                                       placeholder="Type your question here..."
                                       @bind="currentQuestion"
                                       @bind:event="oninput"
                                       @onkeypress="HandleQuestionKeyPress"
                                       disabled="@isAnalyzing" />
                                <button class="oa-qa-send-btn" 
                                        @onclick="AskQuestion"
                                        disabled="@(isAnalyzing || string.IsNullOrWhiteSpace(currentQuestion))">
                                    Ask
                                </button>
                            </div>
                        </div>

                        @* Exit Q&A Mode *@
                        <div class="oa-qa-actions">
                            <button class="oa-action-button" @onclick="ExitQAMode">
                                Exit Q&A Mode
                            </button>
                            <button class="oa-action-button" @onclick="ClearQAHistory">
                                Clear History
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    @* Regular Result Display *@
                    <div class="oa-result-box">
                        <pre>@analysisResult</pre>
                    </div>
                }
                
                @if (!isQAMode)
                {
                    <div class="oa-result-actions">
                        <button class="oa-action-button" @onclick="CopyResults">
                            Kopiera
                        </button>
                        <button class="oa-action-button" @onclick="DownloadResults">
                            Ladda ner
                        </button>
                        <button class="oa-action-button" @onclick="AnalyzeAnother">
                            Analysera annat
                        </button>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private IBrowserFile? uploadedFile;
    private InputFile? fileInput;
    private bool isDragOver;
    private bool isAnalyzing;
    private string analysisStatus = "";
    private string analysisSubStatus = "";
    private string analysisResult = "";
    private string errorMessage = "";
    
    private List<DocumentChunk> documentChunks = [];
    private string fullDocumentText = "";
    private DocumentTypeResult? detectedType;
    private List<AnalysisAction> recommendedActions = [];
    private KursplanResult? kursplanResult;

    private CancellationTokenSource? analysisCancellationTokenSource;
    private DateTime analysisStartTime;
    private bool showAbortButton = false;
    private const int MaxAnalysisTimeMs = 300000; // 5 minutes

    // Q&A mode state
    private bool isQAMode = false;
    private string currentQuestion = "";
    private List<(string Question, string Answer)> qaHistory = [];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("documentAnalysis.initializeDragDrop", "upload-area", "file-input");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to initialize drag-drop: {ex.Message}");
            }
        }
    }

    private void HandleDragEnter() => isDragOver = true;
    private void HandleDragLeave() => isDragOver = false;
    
    private async Task HandleDrop()
    {
        isDragOver = false;
        StateHasChanged();
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        errorMessage = "";
        documentChunks.Clear();
        analysisResult = "";
        kursplanResult = null;
        detectedType = null;
        recommendedActions.Clear();
        
        await ExtractDocumentTextImmediately(e.File);
        StateHasChanged();
    }

    private async Task ExtractDocumentTextImmediately(IBrowserFile file)
    {
        if (file == null) return;

        analysisStatus = $"Läser {file.Name}...";
        
        try
        {
            var extension = Path.GetExtension(file.Name).ToLowerInvariant();
            
            if (extension == ".txt")
            {
                using var stream = file.OpenReadStream(maxAllowedSize: 10485760);
                using var reader = new StreamReader(stream, System.Text.Encoding.UTF8);
                fullDocumentText = await reader.ReadToEndAsync();
            }
            else if (extension == ".docx" || extension == ".doc")
            {
                using var memoryStream = new MemoryStream();
                await file.OpenReadStream(maxAllowedSize: 10485760).CopyToAsync(memoryStream);
                memoryStream.Position = 0;
                
                var (success, text, error) = ExtractTextFromDocxStream(memoryStream);
                if (!success)
                {
                    errorMessage = error;
                    fullDocumentText = "";
                    return;
                }
                fullDocumentText = text;
            }
            else if (extension == ".pdf")
            {
                using var memoryStream = new MemoryStream();
                await file.OpenReadStream(maxAllowedSize: 10485760).CopyToAsync(memoryStream);
                memoryStream.Position = 0;
                
                var (success, text, error) = ExtractTextFromPdfStream(memoryStream);
                if (!success)
                {
                    errorMessage = error;
                    fullDocumentText = "";
                    return;
                }
                fullDocumentText = text;
            }
            else
            {
                errorMessage = $"File type {extension} is not supported. Use .txt, .docx, or .pdf";
                fullDocumentText = "";
                return;
            }

            if (string.IsNullOrWhiteSpace(fullDocumentText))
            {
                errorMessage = "Kunde inte extrahera text från filen.";
                return;
            }

            documentChunks = AnalysisService.SplitIntoChunks(fullDocumentText);
            detectedType = TypeDetector.DetectType(fullDocumentText);
            recommendedActions = TypeDetector.GetRecommendedActions(detectedType.Type);
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid läsning av fil: {ex.Message}";
            fullDocumentText = "";
        }
    }

    private (bool Success, string Text, string Error) ExtractTextFromDocxStream(MemoryStream stream)
    {
        try
        {
            using var doc = DocumentFormat.OpenXml.Packaging.WordprocessingDocument.Open(stream, false);
            
            if (doc.MainDocumentPart == null)
            {
                return (false, "", "Ogiltig DOCX-fil: Ingen dokumentdel hittades");
            }

            var textBuilder = new System.Text.StringBuilder();
            var body = doc.MainDocumentPart.Document.Body;
            
            if (body != null)
            {
                foreach (var paragraph in body.Elements<DocumentFormat.OpenXml.Wordprocessing.Paragraph>())
                {
                    var text = paragraph.InnerText;
                    if (!string.IsNullOrWhiteSpace(text))
                    {
                        textBuilder.AppendLine(text);
                    }
                }

                foreach (var table in body.Elements<DocumentFormat.OpenXml.Wordprocessing.Table>())
                {
                    foreach (var row in table.Elements<DocumentFormat.OpenXml.Wordprocessing.TableRow>())
                    {
                        var rowTexts = new List<string>();
                        foreach (var cell in row.Elements<DocumentFormat.OpenXml.Wordprocessing.TableCell>())
                        {
                            rowTexts.Add(cell.InnerText);
                        }
                        if (rowTexts.Count > 0)
                        {
                            textBuilder.AppendLine(string.Join("\t", rowTexts));
                        }
                    }
                    textBuilder.AppendLine();
                }
            }

            var extractedText = textBuilder.ToString().Trim();
            
            if (string.IsNullOrWhiteSpace(extractedText))
            {
                return (false, "", "Ingen textinnehåll hittades i DOCX-filen");
            }

            return (true, extractedText, "");
        }
        catch (Exception ex)
        {
            return (false, "", $"Fel vid läsning av DOCX: {ex.Message}");
        }
    }

    private (bool Success, string Text, string Error) ExtractTextFromPdfStream(MemoryStream stream)
    {
        try
        {
            using var pdf = PdfDocument.Open(stream);
            var textBuilder = new System.Text.StringBuilder();

            foreach (var page in pdf.GetPages())
            {
                textBuilder.AppendLine(page.Text);
            }

            var extractedText = textBuilder.ToString().Trim();

            if (string.IsNullOrWhiteSpace(extractedText))
            {
                return (false, "", "Ingen textinnehåll hittades i PDF-filen");
            }

            return (true, extractedText, "");
        }
        catch (Exception ex)
        {
            return (false, "", $"Fel vid läsning av PDF: {ex.Message}");
        }
    }

    private void RemoveFile()
    {
        uploadedFile = null;
        analysisResult = "";
        errorMessage = "";
        documentChunks.Clear();
        fullDocumentText = "";
        detectedType = null;
        recommendedActions.Clear();
        kursplanResult = null;
    }

    private async Task AnalyzeDocument(string analysisType)
    {
        if (string.IsNullOrEmpty(fullDocumentText))
        {
            errorMessage = "Ingen dokumenttext tillgänglig. Ladda upp en fil.";
            return;
        }

        isAnalyzing = true;
        analysisStatus = "Analyserar dokument...";
        analysisSubStatus = "";
        kursplanResult = null;
        showAbortButton = false;
        analysisStartTime = DateTime.UtcNow;
        
        analysisCancellationTokenSource = new CancellationTokenSource();
        analysisCancellationTokenSource.CancelAfter(MaxAnalysisTimeMs);

        StateHasChanged();

        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            if (isAnalyzing)
            {
                showAbortButton = true;
                StateHasChanged();
            }
        });

        try
        {
            switch (analysisType)
            {
                case "summarize":
                    await AnalyzeSummarize();
                    break;
                    
                case "qa":
                    await AnalyzeQA();
                    break;
                    
                default:
                    // Handle Swedish kursplan actions (kunskapsmal, etc.)
                    await AnalyzeKursmal();
                    break;
            }
        }
        catch (OperationCanceledException)
        {
            analysisResult = "Analys avbruten av användaren.";
            analysisStatus = "Avbryten";
            analysisSubStatus = "";
        }
        catch (Exception ex)
        {
            analysisResult = $"Fel vid analys: {ex.Message}";
        }
        finally
        {
            isAnalyzing = false;
            showAbortButton = false;
            analysisCancellationTokenSource?.Dispose();
            analysisCancellationTokenSource = null;
            StateHasChanged();
        }
    }

    private void AbortAnalysis()
    {
        analysisCancellationTokenSource?.Cancel();
        isAnalyzing = false;
        showAbortButton = false;
        analysisStatus = "";
        analysisSubStatus = "";
        StateHasChanged();
    }

    private async Task AnalyzeSummarize()
    {
        analysisStatus = "Generating summary...";
        analysisSubStatus = "Processing document with AI";
        StateHasChanged();
        await Task.Delay(300);

        // Check if chat service is available
        if (Dashboard.ChatService == null)
        {
            analysisResult = "ERROR\n\nAI Chat Service is not initialized. Please ensure the LLM is loaded.";
            return;
        }

        try
        {
            // Create a summarization prompt
            var prompt = $@"Please provide a concise summary of the following document. Focus on the main points, key information, and overall purpose.

Document to summarize:

{fullDocumentText}

Provide a clear, well-structured summary in 3-5 paragraphs.";

            // Update status
            analysisStatus = "AI is analyzing the document...";
            StateHasChanged();

            // Get current generation settings
            var settings = Dashboard.SettingsService.ToGenerationSettings();

            // Get summary from LLM
            var summary = await Dashboard.ChatService.SendMessageAsync(
                message: prompt,
                ragMode: false,  // Don't use RAG for summarization
                debugMode: false,
                showPerformanceMetrics: false,
                generationSettings: settings,
                personality: null,
                useGpu: true,
                gpuLayers: 35
            );

            // Format the result
            analysisResult = $"DOCUMENT SUMMARY\n\n{summary}";
            
            analysisStatus = "Summary complete!";
            analysisSubStatus = "";
        }
        catch (Exception ex)
        {
            analysisResult = $"ERROR\n\nFailed to generate summary: {ex.Message}";
            analysisStatus = "Summary failed";
        }
    }

    private async Task AnalyzeQA()
    {
        analysisStatus = "Initializing Q&A mode...";
        StateHasChanged();
        await Task.Delay(300);

        // Check if chat service is available
        if (Dashboard.ChatService == null)
        {
            analysisResult = "ERROR\n\nAI Chat Service is not initialized. Please ensure the LLM is loaded.";
            return;
        }

        // Enable Q&A mode
        isQAMode = true;
        qaHistory.Clear();
        currentQuestion = "";
        analysisResult = "Q&A_MODE_ACTIVE"; // Marker to show results section

        analysisStatus = "Q&A mode ready";
        analysisSubStatus = "Ask questions about your document";
    }

    private async Task AskQuestion()
    {
        if (string.IsNullOrWhiteSpace(currentQuestion) || Dashboard.ChatService == null)
            return;

        var question = currentQuestion.Trim();
        currentQuestion = ""; // Clear input

        isAnalyzing = true;
        analysisStatus = $"Processing question...";
        StateHasChanged();

        try
        {
            // Create Q&A prompt with document context
            var prompt = $@"Based on the following document, please answer this question:

Question: {question}

Document content:
{fullDocumentText}

Provide a clear, accurate answer based only on the information in the document. If the answer is not in the document, please say so.";

            // Get current generation settings
            var settings = Dashboard.SettingsService.ToGenerationSettings();

            // Get answer from LLM
            var answer = await Dashboard.ChatService.SendMessageAsync(
                message: prompt,
                ragMode: false,
                debugMode: false,
                showPerformanceMetrics: false,
                generationSettings: settings,
                personality: null,
                useGpu: true,
                gpuLayers: 35
            );

            // Add to history
            qaHistory.Add((question, answer));

            analysisStatus = $"Ready for next question ({qaHistory.Count} asked)";
            analysisSubStatus = "";
        }
        catch (Exception ex)
        {
            qaHistory.Add((question, $"ERROR: {ex.Message}"));
            analysisStatus = "Error processing question";
        }
        finally
        {
            isAnalyzing = false;
            StateHasChanged();
        }
    }

    private async Task HandleQuestionKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(currentQuestion) && !isAnalyzing)
        {
            await AskQuestion();
        }
    }

    private void ExitQAMode()
    {
        isQAMode = false;
        analysisResult = ""; // Clear results
        qaHistory.Clear();
        currentQuestion = "";
    }

    private void ClearQAHistory()
    {
        qaHistory.Clear();
        analysisStatus = "Q&A mode ready";
        analysisSubStatus = "Ask questions about your document";
    }

    private async Task AnalyzeKursmal()
    {
        analysisStatus = "Extraherar kursmål...";
        StateHasChanged();
        await Task.Delay(300);

        var docType = detectedType?.Type ?? DocumentTypeDetector.DocumentType.SwedishYhKursplan;
        kursplanResult = KursplanService.ExtractKursmal(fullDocumentText, docType);

        if (kursplanResult.TotalItems > 0)
        {
            analysisStatus = $"Hittade {kursplanResult.TotalItems} kursmål i {kursplanResult.Sections.Count} sektioner";
            analysisSubStatus = "";
            StateHasChanged();
            await Task.Delay(200);
            
            // Use FormatResult for clean output matching your requirements
            analysisResult = KursplanService.FormatResult(kursplanResult);
        }
        else
        {
            analysisStatus = "Inga strukturerade mål hittades";
            analysisResult = "Kunde inte hitta Kunskaper, Färdigheter eller Kompetenser i dokumentet.\n\n";
            analysisResult += "Förväntad struktur:\n#Kunskaper\n#Färdigheter\n#Kompetenser\n\n";
            analysisResult += "Råtext (första 1000 tecken):\n\n";
            analysisResult += fullDocumentText.Length > 1000 
                ? fullDocumentText.Substring(0, 1000) + "..." 
                : fullDocumentText;
        }
    }

    private string GetTypeClass(DocumentTypeDetector.DocumentType type)
    {
        return type switch
        {
            DocumentTypeDetector.DocumentType.SwedishYhKursplan => "kursplan yh",
            DocumentTypeDetector.DocumentType.SwedishSkolverketKursplan => "kursplan skolverket",
            DocumentTypeDetector.DocumentType.SwedishKursplan => "kursplan",
            _ => ""
        };
    }

    private string GetActionIcon(string actionId)
    {
        return actionId switch
        {
            "kunskapsmal" => "[K]",
            "centralinnehall" => "[CI]",
            "amnesmal" => "[A]",
            "betygskriterier" => "[B]",
            _ => "[?]"
        };
    }

    private async Task CopyResults()
    {
        if (string.IsNullOrEmpty(analysisResult))
        {
            errorMessage = "Ingen innehåll att kopiera.";
            return;
        }

        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", analysisResult);
            var originalResult = analysisResult;
            analysisResult = "? Kopierad till urklipp!";
            StateHasChanged();
            await Task.Delay(2000);
            analysisResult = originalResult;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Kunde inte kopiera: {ex.Message}";
        }
    }

    private async Task DownloadResults()
    {
        if (string.IsNullOrEmpty(analysisResult))
        {
            errorMessage = "Ingen innehåll att ladda ner.";
            return;
        }

        try
        {
            var fileName = $"kursmal_{DateTime.Now:yyyyMMdd_HHmmss}.txt";
            var bytes = System.Text.Encoding.UTF8.GetBytes(analysisResult);
            
            await JSRuntime.InvokeVoidAsync("documentAnalysis.downloadFile", fileName, Convert.ToBase64String(bytes));
        }
        catch (Exception ex)
        {
            errorMessage = $"Kunde inte ladda ner: {ex.Message}";
        }
    }

    private void AnalyzeAnother()
    {
        uploadedFile = null;
        analysisResult = "";
        errorMessage = "";
        documentChunks.Clear();
        detectedType = null;
        recommendedActions.Clear();
        kursplanResult = null;
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = ["B", "KB", "MB", "GB"];
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len /= 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}
