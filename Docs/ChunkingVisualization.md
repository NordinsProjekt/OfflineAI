# Text Chunking Flow Visualization

## Before: Single Large Memory Fragment ?

```
???????????????????????????????????????????????????????????
?  File: treasure_hunt_rules.txt (10,000 words) ?
???????????????????????????????????????????????????????????
                  ?
???????????????????????????????????????????????????????????
?  VectorMemory   ?
?  ????????????????????????????????????????????????????? ?
?  ? Fragment 1: [Treasure Hunt Rules]     ? ?
?  ? Embedding: [0.12, 0.45, -0.33, ..., 0.78] (384d)? ?
?  ? Content: [ENTIRE 10,000 WORD DOCUMENT]           ? ?
?  ????????????????????????????????????????????????????? ?
???????????????????????????????????????????????????????????
           ?
        User Query: "How do I attack?"
            ?
???????????????????????????????????????????????????????????
?  Semantic Search Results     ?
?  ????????????????????????????????????????????????????? ?
?  ? ? Fragment 1: Score 0.68 (LOW!)              ? ?
?  ?   Contains attack rules BUT buried in 9,950   ? ?
?  ?   other words about movement, items, victory, ? ?
?  ?   setup, player count, etc.      ? ?
?  ????????????????????????????????????????????????????? ?
???????????????????????????????????????????????????????????
   ?
         AI gets confused
```

---

## After: Smart Chunking ?

```
???????????????????????????????????????????????????????????
?  File: treasure_hunt_rules.txt (10,000 words)      ?
???????????????????????????????????????????????????????????
       ?
         LoadFromFileWithSmartChunkingAsync()
    ?
???????????????????????????????????????????????????????????
?  Step 1: Split by Headers    ?
?  ????????????????????????????????????????????????????? ?
?  ? # Game Setup    ? # Combat Rules  ? # Movement    ? ?
?  ? (800 words)     ? (2,000 words)   ? (500 words)   ? ?
?  ????????????????????????????????????????????????????? ?
???????????????????????????????????????????????????????????
  ?
???????????????????????????????????????????????????????????
?  Step 2: Sub-chunk Large Sections       ?
?  ????????????????????????????????????????????????????? ?
?? Game Setup      ? Combat Rules    ? Movement      ? ?
?  ? (keep intact)   ? (split into 4)  ? (keep intact) ? ?
?  ????????????????????????????????????????????????????? ?
???????????????????????????????????????????????????????????
       ?
???????????????????????????????????????????????????????????
?  VectorMemory (50 focused fragments)             ?
?  ????????????????????????????????????????????????????? ?
?  ? Frag 1: [Game Setup]          ? ?
?  ?   Embedding: [0.31, -0.12, 0.88, ...]? ?
?  ?   Content: "Place board in center. Each player   ? ?
?  ?   chooses a character card..."       ? ?
?  ????????????????????????????????????????????????????? ?
?  ????????????????????????????????????????????????????? ?
?  ? Frag 10: [Combat Rules_chunk_1]        ? ?
?  ?   Embedding: [0.67, 0.34, -0.21, ...]? ?
?  ? Content: "To attack, roll 2d6 and add your    ? ?
?  ?   attack bonus from equipment..."    ? ?
?  ????????????????????????????????????????????????????? ?
?  ????????????????????????????????????????????????????? ?
?  ? Frag 11: [Combat Rules_chunk_2]          ? ?
?  ?   Embedding: [0.72, 0.41, -0.18, ...]           ? ?
?  ?   Content: "Defender rolls 1d6 + defense. If    ? ?
?  ?   attack exceeds defense, deal damage..."        ? ?
?  ????????????????????????????????????????????????????? ?
?  ????????????????????????????????????????????????????? ?
?  ? Frag 12: [Combat Rules_chunk_3]      ? ?
?  ?   Embedding: [0.69, 0.38, -0.15, ...]           ? ?
?  ?   Content: "Critical hits on natural 12s deal   ? ?
?  ?   double damage. Fumbles on 2s drop weapon."  ? ?
?  ????????????????????????????????????????????????????? ?
?  ? ... (47 more fragments) ...      ? ?
???????????????????????????????????????????????????????????
         ?
        User Query: "How do I attack?"
              Query Embedding: [0.65, 0.39, -0.19, ...]
    ?
???????????????????????????????????????????????????????????
?  Cosine Similarity Calculation        ?
?  ????????????????????????????????????????????????????? ?
?  ? cos_sim(query, frag_1)  = 0.42   ? ?
?  ? cos_sim(query, frag_10) = 0.94 ? HIGH MATCH!   ? ?
?  ? cos_sim(query, frag_11) = 0.89 ? HIGH MATCH!     ? ?
?  ? cos_sim(query, frag_12) = 0.76 ? RELEVANT!       ? ?
?  ? cos_sim(query, frag_20) = 0.35  ? ?
?  ? ... (other scores) ...      ? ?
?  ????????????????????????????????????????????????????? ?
???????????????????????????????????????????????????????????
              ?
???????????????????????????????????????????????????????????
?  Top 3 Results (scores > 0.7, sorted descending)   ?
?  ????????????????????????????????????????????????????? ?
?  ? ? Frag 10: Score 0.94   ? ?
?  ?   "To attack, roll 2d6 and add attack bonus..."  ? ?
?  ????????????????????????????????????????????????????? ?
?  ? ? Frag 11: Score 0.89     ? ?
?  ?   "Defender rolls 1d6 + defense. Deal damage..." ? ?
?  ????????????????????????????????????????????????????? ?
?  ? ? Frag 12: Score 0.76            ? ?
?  ?   "Critical hits on natural 12s deal double..."  ? ?
?  ????????????????????????????????????????????????????? ?
???????????????????????????????????????????????????????????
   ?
???????????????????????????????????????????????????????????
?  LLM Prompt Context (Only relevant chunks!)        ?
?  ????????????????????????????????????????????????????? ?
?  ? System: Answer based on this context:            ? ?
?  ?           ? ?
?  ? [Relevance: 0.940]  ? ?
?  ? To attack, roll 2d6 and add attack bonus...      ? ?
?  ?            ? ?
?  ? [Relevance: 0.890]? ?
?  ? Defender rolls 1d6 + defense. Deal damage...  ? ?
?  ?          ? ?
?  ? [Relevance: 0.760]              ? ?
?  ? Critical hits on natural 12s deal double...      ? ?
?  ?        ? ?
?  ? User: How do I attack?             ? ?
?  ????????????????????????????????????????????????????? ?
???????????????????????????????????????????????????????????
 ?
???????????????????????????????????????????????????????????
?  AI Response (Accurate!)              ?
?  ????????????????????????????????????????????????????? ?
?  ? "To attack in Treasure Hunt, roll 2d6 and add    ? ?
?  ? your attack bonus from equipment and abilities.   ? ?
?  ? The defender rolls 1d6 plus their defense value.  ? ?
?? If your attack total is higher, you deal damage  ? ?
?  ? equal to the difference. Natural 12s are critical ? ?
?  ? hits and deal double damage!"   ? ?
?  ????????????????????????????????????????????????????? ?
???????????????????????????????????????????????????????????
```

---

## Key Improvements

| Metric | Without Chunking | With Smart Chunking |
|--------|------------------|---------------------|
| **Fragments Created** | 1 | 50 |
| **Top Match Score** | 0.68 | 0.94 |
| **Context Sent to AI** | 10,000 words | 300 words |
| **Answer Accuracy** | ????? | ????? |
| **Response Time** | Slower | Faster |
| **Token Cost** | High | Low |

---

## The Math Behind Cosine Similarity

```
Query Embedding:     [0.65, 0.39, -0.19, ..., 0.42]
Fragment Embedding:  [0.67, 0.34, -0.21, ..., 0.38]
            ?
    Cosine Similarity = dot(A,B) / (||A|| * ||B||)
      ?
                 Score: 0.94 (Very Similar!)
```

**Score Interpretation:**
- **1.0** = Identical meaning (rare)
- **0.9-1.0** = Extremely similar (perfect match!)
- **0.7-0.9** = Highly relevant (good context)
- **0.5-0.7** = Somewhat related (maybe useful)
- **< 0.5** = Not relevant (filtered out)

---

## Real Example from Console

```sh
> /debug How do critical hits work?

=== Relevant Memory Fragments ===
[Relevance: 0.924]
[Combat Rules_chunk_3]
Critical hits occur on natural 12s and deal double damage. Some weapons have 
critical multipliers that stack with this base damage.

[Relevance: 0.856]
[Combat Rules_chunk_2]
The attacker rolls 2d6 and adds their attack bonus. Compare totals. If attack 
is higher, deal damage equal to the difference.

[Relevance: 0.732]
[Advanced Combat_chunk_1]
Weapons with the "keen" property increase your critical threat range, making 
critical hits more likely.
=================================
```

? **Perfect!** All 3 chunks are about combat and criticals, with the most relevant one scoring 0.924!
